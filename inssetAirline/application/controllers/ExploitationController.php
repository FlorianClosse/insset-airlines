<?php 

class ExploitationController extends Zend_Controller_Action
{
	public function indexAction()
    {
	    $messageModifVol = new MessageModifVol();
	    $jdb = new JournalDeBord();
	    $vol = new Vol();
	    $avion= new Avion();
	    $pilote = new Pilote();
	    
	    if(isset($_POST['btEnvoyer']))
	    {
	    	$valeur = $this->_getParam('idJDB');
    		
    		$maligne = $messageModifVol->createRow();
    		$maligne -> message = $_POST['commentaire'];
	    	$maligne -> statut = 'debut';
	    	$maligne -> dateMessage = date('Y-m-d');
	    	$maligne -> idJournalDeBord = $valeur;
	    	$maligne -> save();
	    	$this->view->message = 'Le message a été transmit.';
	    }
	    else
	    {
	    	if(isset($_POST['choixDuVol']))
	    	{
 	    		if(!empty($_POST['date']))
	    		{
	    			$lesJDB = $jdb->getRecuperLesVolsAujourdHui($_POST['date']);
	    			foreach($lesJDB as $uneLigne)
	    			{
	    				$monJDB = $jdb->find($uneLigne['idJournalDeBord'])->current();
	    				$monVol = $vol->find($monJDB['idVol'])->current();
	    				
	    				
	    				if($_POST['aeroportDepart'] == $monVol['aeroportDepart'])
	    				{
	    					if($_POST['aeroportArrivee'] == $monVol['aeroportArrivee'])
	    					{
	    						$monAvion = $avion->find($monJDB['idAvion'])->current();
	    						$monPilote = $pilote->find($monJDB['idPilote'])->current();
	    						$monCoPilote = $pilote->find($monJDB['idCoPilote'])->current();
	    						
	    						
	    						$tabId[$uneLigne['idJournalDeBord']] = $uneLigne['idJournalDeBord'];
	    						$tabAvion[$uneLigne['idJournalDeBord']] = $monAvion['numImmatriculation'];
	    						$tabPilote[$uneLigne['idJournalDeBord']] = $monPilote['nomPilote'].' '.$monPilote['prenomPilote'];
	    						$tabCoPilote[$uneLigne['idJournalDeBord']] = $monCoPilote['nomPilote'].' '.$monCoPilote['prenomPilote'];
	    						$tabVol[$uneLigne['idJournalDeBord']] = $monVol['numVol'];
	    						$lesV[$uneLigne['idJournalDeBord']] = $uneLigne['idJournalDeBord'];
	    					}
	    				}
	    			}
	    			if(isset($tabId))
	    			{
		    			$this->view->id = $tabId;
		    			$this->view->avion = $tabAvion;
		    			$this->view->pilote = $tabPilote;
		    			$this->view->coPilote = $tabCoPilote;
		    			$this->view->vol = $tabVol;
		    			$this->view->lesVols = $lesV;
		    			$this->view->message = 'Choisir le vol a commenter';
	    			}
	    			else
	    			{
	    				$this->view->message = 'Aucun vol ne correspond...';
	    			}
	    		}
	    	}
	    	else
	    	{
	    		$valeur = $this->_getParam('idJDB');
    			if(isset($valeur))
    			{
    				$formulaire = new Zend_Form;
    				$formulaire -> setAttrib('id','formulaire');
    				$formulaire -> setMethod('post');
    				$formulaire -> setAction('/exploitation/index?idJDB='.$valeur);
    				 
    				$commentaire = new Zend_Form_Element_Textarea('commentaire');
    				$commentaire ->setLabel('Taper votre commentaire pour ce vol');
    				$commentaire ->setAttrib('id', 'commentaire');
    				$commentaire ->setRequired(TRUE);
    				$formulaire->addElement($commentaire);
    				
    				$envoyer = new Zend_Form_Element_Submit('btEnvoyer');
    				$envoyer -> setLabel('Ajouter');
    				$formulaire -> addElement($envoyer);
    				
    				$this->view->formulaire = $formulaire;
    			}
    			else
    			{
	    			$avion = new Avion();
		    		$lesAvions = $avion->fetchAll();
		    		
		    		$formulaireChoixVol = new Zend_Form;
		    		$formulaireChoixVol -> setAttrib('id','formulaireChoixVol');
		    		$formulaireChoixVol -> setMethod('post');
		    		$formulaireChoixVol -> setAction('/exploitation/index');
		    		
		    		$formulaireChoixVol->addElement(fonctionAeroport('aeroportDepart')->setLabel('Aéroport de départ'));
		    		$formulaireChoixVol->addElement(fonctionAeroport('aeroportArrivee')->setLabel('Aéroport d\'arrivée'));
		    		 
		    		$date = new Zend_Form_Element_Text('date');
		    		$date -> setAttrib('id', 'datepicker');
		    		$date -> setValue(date('Y-m-d'));
		    		$date -> setLabel('Choisir la date de vol');
		    		$formulaireChoixVol -> addElement($date);
		    		
		    		$envoyer = new Zend_Form_Element_Submit('choixDuVol');
		    		$envoyer -> setLabel('Ajouter');
		    		$formulaireChoixVol -> addElement($envoyer);
		    		
		    		$this->view->formulaire = $formulaireChoixVol;
		    		$this->view->message = 'Spécifier les parametres pour trouver le vol que vous souhaitez commenter';
    			}
	    	}
	    	
	    }
    }
}
    